<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.6.11/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.8.7/polyfill.js"></script>
    <script src="https://vega.github.io/vega/assets/promise.min.js"></script>
    <script src="https://vega.github.io/vega/assets/symbol.min.js"></script>
    <script src="https://vega.github.io/vega/assets/fetch.min.js"></script>
    

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>

    <script src="https://cdn.jsdelivr.net/npm/vega@5/build-es5/vega.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4/build-es5/vega-lite.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6/build-es5/vega-embed.js"></script>
    <!--D3-->
    <script src="https://d3js.org/d3.v5.min.js"></script>

        <!--Arquero-->
    <script src="https://cdn.jsdelivr.net/npm/arquero@latest"></script>

    <!-- leaflet -->
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js" integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>


        <!-- for custom zoom/home buttons from here: https://gis.stackexchange.com/questions/127286/home-button-leaflet-map -->
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>


    <!-- bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">

</head>
<body>

  <style>

  .chartdest {
    width: 100%;
    height: 250px;
    margin-bottom: 50px;
  }

  code {
    color: white;
    background-color: rgb(73, 73, 73);
    padding-left: 3px;
    padding-right: 3px;
  }
  </style>



  <div class="container-fluid">

    <h1>External events</h1>
    
    <div class="row my-4 border">
        <div class="colorLabel" style="background:red;color:white; width:130px;">Red</div>
        <div class="colorLabel" style="background:purple; color:white; width:130px;">Purple</div>

        <div class="lineLabel" style="background:black;color:white; width:130px;">BQE</div>
        <div class="lineLabel" style="background:black; color:white; width:130px;">SI_Expwy</div>
    </div>

    <div class="row mt-4 mb-2">
        <div class="col-12">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <table class="table table-tight" id="table24">
                        <thead>
                            <tr>
                                <th scope="col">Location</th>
                                <th scope="col" class="hide">Sort</th>
                                <th scope="col">Last 24 hours <span class="font-weight-normal">(µg/m<sup>3</sup>)</span></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                    <hr class="my-2">
                        <p class="fs-sm hide" id="exceeds" style="color:red;"><i class="fas fa-exclamation-circle mr-1"></i>Exceeds NAAQS 24-hour standard</p>
                        <p class="fs-sm" id="allUnder" style="color:green;"><i class="fas fa-check-circle mr-1"></i>All levels are below the NAAQS 24-hour standard (35 µg/m<sup>3</sup>)</p>

                        <p class="fs-xs hide" id="insufficient"><em>*Monitor reported less than 18 hours in the last day.</em></p>

                    <div class="btn-group mb-2">
                        <button href="#table24" class="fs-sm btn btn-sm btn-light mr-1" onclick="resetZoom()"><i class="fas fa-redo mr-1" aria-hidden="true"></i>Clear</button>

                        <button type="button" class="btn btn-sm d-block d-md-none btn-outline-primary mr-1" data-toggle="modal" data-target="#mapModal">
                            Monitors
                          </button>
    
                        <button type="button" class="btn btn-sm btn-outline-primary float-right" data-toggle="modal" data-target="#archiveModal">
                            <i class="fas fa-download mr-1" aria-hidden="true"></i>Download
                          </button>
                    </div>


                    


                </div>

                <div class="col-md-8 border-left">


                    <!-- Chart set -->
                    <div style="width:100%" class="">

                    <div id="numberinput" class="float-right pt-1"
                    style="font-size: 12px;">
                        <label for="inputNum" style="display:inline-block; font-size: 12px;">Show last</label>
                        <input inputmode="numeric" pattern="[0-9]*" type="number" style="display:inline-block" id="inputNum" name="inputNum" min="1" max="7">
                        days.
                        </form>
                    </div>

                        <span class="fs-sm"><span class="font-weight-bold">Hourly PM2.5 (in µg/m<sup>3</sup>)</span> | <span style="color:red">NAAQS&nbsp;24-hour&nbsp;PM2.5&nbsp;standard&nbsp;(35 µg/m<sup>3</sup>)</span></span>
                    </div>

                    <div id="vis" style="width: 100%; height: 45vh;" class="mt-2">
                    CHART
                    </div>

                    <div id="map" class="d-none d-md-block">
                        MAP
                    </div>

                </div>
            </div>
        </div>
    </div>



    <div class="row hide">
        <!-- Average value box -->
        <div class="rtaqbox p-1 hide my-1" id="averageBox">
            <p class="fs-md"><strong>Last 24 hours:</strong></p>

            <p class="fs-md"><span id="locColor"><i class="fas fa-square mr-1"></i></span><span id="locationSend" class="home-label font-weight-bold">LOCATION</span>: the average PM2.5 at this location is <span id="locAverage" style="font-weight:bold;" class="badge badge-primary">XX</span>. This is <span id="aboveBelow" style="font-weight:bold;">XX</span> the <a href="https://www.epa.gov/criteria-air-pollutants/naaqs-table">24-hour NAAQS standard of 35</a>.</p>
        </div>

        <!-- last 24-hour info box -->
        <div class="infobox rtaqbox hide" id="locInfoBox">
            <div id="locInfoDesc">

                <p class="fs-md"><strong>Last 24 hours</strong> </p>
                <p class="fs-md">No value from the <span id="locColor2"><i class="fas fa-square mr-1"></i></span><span id="locationSend2" class="font-weight-bold"></span> monitor. Sometimes monitors go down or have other problems. We only produce average values if there are more than 18 hourly readings over the last 24 hours.</p>

            </div>
        </div>
    </div>
    

    
    


  </div>



<script type="text/javascript">
  /* 
// ---- REALTIME AQ ---- //

CHOOSING DATA: Variable rtaqData is set in realtime.html template, determining whether this is local or live.

READING MONITORS: If a monitor is in the feed, it needs an entry in monitor_locations.csv; loc_col needs to equal SiteName in the datafeed.

NULL HANDLING: in getStationsFromData, we get unique times and join that to the data for each station, getting dataWithNulls that has null values rather than no rows for each monitor-x-starttime. This creates interrupted lines when there are no readings.

USING DEC_AVG: This app excludes DEC_Avg from conventional functionality. monitors_group_noDEC sets the map bounds without the DEC Average monitor, which is given an abitrary off-coast lat/long. if (x != 'DEC_Avg') changes what happens to the map zoom on button click - just zooming to the initial extent if somebody selects the DEC_Avg option.


/*
  IF HAMILTON BRIDGE ISN'T IN THE ACTIVE LOCATIONS,
  THEN, ADD A UNIQUE PIN
*/

// ADDING A NOTE


// initialize variables (other variables are initialized closer to their prime use)
var rtaqData = 'https://raw.githubusercontent.com/nychealth/nyccas-data/refs/heads/main/portal/view.csv'
var current_spec;
var dt;
var times;
var fullTable;
var locSelect = "No location"
var res;
var floorDate;
var maxTime;
var maxTimeMinusDay;
var filter;
var stations = [];
var allMonitorLocations;
var activeMonitors = [];
var checkedSites = [];
var getChecked;
var boxes;
var revisedSpecTwo = {};
var opacity;
var stroke; 
var loc;
var locData = [];
var values = [];
var max;
var filter2;
var specTwo;
var ftl;
var dataWithNulls = aq.table();
var chartStart // takes either floorDate or filtered date
var myView;

 
// ---- INITIAL: ingest data feed ---- // 
aq.loadCSV(rtaqData).then(data => {

    dt = data
        .derive({starttime: d => op.parse_date(d.starttime)})
        .orderby("starttime")
        .print()
    
    fullTable = dt.objects();                       // puts the data into fullTable to use. 
    floorDate = new Date(fullTable[0].starttime)    // creates earliest date in 7-day feed - used for time filter
    console.log('Showing data since: ' + floorDate)
    floorDate = Date.parse(floorDate)               // converting to milliseconds
    chartStart = floorDate

    // get most recent time
    ftl = fullTable.length - 1
    maxTime = fullTable[ftl].starttime
    maxTime = Date.parse(maxTime)
    maxTimeMinusDay = maxTime - 86400000

    // console.log("fullTable:", fullTable);
    getStationsFromData();

});

// ---- NEXT: GET STATIONS REPORTING DATA & begin Null handling---- // 
function getStationsFromData() {
    var sites = [];
    for (let i = 0; i<fullTable.length; i++) {
        sites.push(fullTable[i].SiteName)
    }
    stations = [...new Set(sites)]

    // Null Handling
    times = dt.select('starttime','timeofday').dedupe('starttime') // creats an arquero table of only times

    var accumulatedRows = [];
    for (let i = 0; i < stations.length; i++) {

        if (i == 0 ) {
            times = dt
            .select('starttime','timeofday')
            .dedupe('starttime')
            .derive({ SiteName: aq.escape(stations[i])})

            var thisStation = dt.filter(aq.escape(d => d.SiteName === stations[i]))      // for this station, get data
            thisStation = thisStation.select(aq.not('SiteName','Operator','timeofday'))  // drop the other cols but starttime and Value              

            var thisStationFull = times.join_full(thisStation, 'starttime')             // join to times

            dataWithNulls = thisStationFull; // sets up initial table

        } else {
            times = dt
            .select('starttime','timeofday')
            .dedupe('starttime')
            .derive({ SiteName: aq.escape(stations[i])})


            var thisStation = dt.filter(aq.escape(d => d.SiteName === stations[i]))      // for this station, get data
            thisStation = thisStation.select(aq.not('SiteName','Operator','timeofday'))  // drop the other cols but starttime and Value              

            var thisStationFull = times.join_full(thisStation, 'starttime')             // join to times

            // put thisStationFull into one table
            dataWithNulls = dataWithNulls.concat(thisStationFull); // adds subsequent loops to the fll table
        }
 
    }

    // with stations, load locations from data file
    loadMonitorLocations();
}

let colors = [
  "#e41a1c",  // strong red
  "#377eb8",  // medium blue
  "#4daf4a",  // medium green
  "#984ea3",  // purple
  "#ff7f00",  // orange
  "#dca936",  // golden yellow
  "#a65628",  // brown
  "#f781bf",  // pink
  "#999999",  // gray
  "#66c2a5",  // teal
  "#fc8d62",  // salmon
  "#1fbfc3",  // cyan (replacing light blue)
  "#c85a9f",  // magenta
  "#6ba54a",  // darker lime green
  "#b15928"   // dark brown/rust
];


// ---- LOAD LOCATIONS: Creates list of active monitors and their metadata (lat/longs, colors, etc) ---- //
function loadMonitorLocations() {
    d3.csv("https://raw.githubusercontent.com/nychealth/nyccas-data/refs/heads/main/portal/station-new.csv").then(data => {
        allMonitorLocations = data;

        // assign .Color to each item in allMonitorLocations, from colors
        for (let i = 0; i < allMonitorLocations.length; i++) {
            allMonitorLocations[i].Color = colors[i % colors.length];
        }

        console.log('all monitor locations:')
        console.log(allMonitorLocations)

        for (let i = 0; i < allMonitorLocations.length; i++) {
            // if stations includes allMonitorLocations[i].loc_col, push to activeMonitors
            if (stations.includes(allMonitorLocations[i].loc_col)) {
                activeMonitors.push(allMonitorLocations[i]);
            }
        }

        // alphabetize activeMonitors for color coordination
        activeMonitors.sort(GetSortOrder("loc_col"));
        console.log('active Monitors:')
        console.log(activeMonitors)

        // Draw page
        // drawMap();
        drawCheckboxes();
        renderSpec(dataWithNulls.objects());
        printRecentAverage();
    });
}

// ---- DRAW CHECKBOXES, table, and box listener ---- //

function drawCheckboxes() {
    // console.log('drawing checkboxes...')

    for (let i = 0; i < activeMonitors.length; i++) {

        let tableCheckBox = 
                `
                <tr id="row-${activeMonitors[i].loc_col}" class="location-row" data-loc="${activeMonitors[i].loc_col}" data-color="${activeMonitors[i].Color}">
                <th scope="row">
                    <input type="checkbox" id="${activeMonitors[i].loc_col}" name="${activeMonitors[i].loc_col}" value="${activeMonitors[i].Color}">
                    <label for="${activeMonitors[i].loc_col}"><span style="color: ${activeMonitors[i].Color};"><i class="fas fa-square mx-1"></i></span>${activeMonitors[i].Location}</label>
                    </th>
                <td id="value-${activeMonitors[i].loc_col}-1" class="hide">Invisible column with all values - for sorting</td>
                <td>
                    <div id="value-${activeMonitors[i].loc_col}-2" style="background-color:lightblue;width:0%;" class="pr-1 my-1 barchart">
                    </div>
                </td>

                </tr>
                `
        
        document.getElementById('tableBody').innerHTML += tableCheckBox

    }

    listenBoxes()
    listenHover()
}

//-- Event listener on location row hover --//
function listenHover() {
  const rows = document.querySelectorAll('.location-row')

  let hoveredSite = []

  rows.forEach(row => {
    row.addEventListener('mouseenter', (e) => {

      // create nodelist of all checked items
      getChecked = document.querySelectorAll('input[type=checkbox]:checked');

        checkedSites = []; // clear the array of checked items
          for (let i = 0; i < getChecked.length; i++) {
          var siteName = getChecked[i].name
          var siteColor = getChecked[i].value
          var thisSite = {
            "siteName": `${siteName}`,
            "color": `${siteColor}`
          }
        checkedSites.push(thisSite)
      }

      // then, add the hovered site to it.
      const site = e.currentTarget.getAttribute('data-loc')
      const color = e.currentTarget.getAttribute('data-color')

      hoveredSite = { siteName: site, color: color }  

      checkedSites.push(hoveredSite)

      // renderSpec(dataWithNulls, checkedSites)

    })

    // on mouse leave, only chart checkedBoxes
    row.addEventListener('mouseleave', () => {
      // create nodelist of all checked items
      getChecked = document.querySelectorAll('input[type=checkbox]:checked');

      checkedSites = []; // clear the array of checked items
      for (let i = 0; i < getChecked.length; i++) {
          var siteName = getChecked[i].name
          var siteColor = getChecked[i].value
          var thisSite = {
              "siteName": `${siteName}`,
              "color": `${siteColor}`
          }
          checkedSites.push(thisSite)
      }
  
      // renderSpec(dataWithNulls, checkedSites)
    })
  })
}

//-- Event listener on checkboxes --//

function listenBoxes() {

    boxes = document.querySelectorAll('input[type=checkbox]');
    boxes.forEach(box => {
        box.addEventListener('click', (ev) => {

            // console.log(ev.target.checked, ev.target.name, ev.target.value);

            // create nodelist of all checked items
            getChecked = document.querySelectorAll('input[type=checkbox]:checked');

            checkedSites = []; // clear the array of checked items
            for (let i = 0; i < getChecked.length; i++) {
                var siteName = getChecked[i].name
                var siteColor = getChecked[i].value
                var thisSite = {
                    "siteName": `${siteName}`,
                    "color": `${siteColor}`
                }
                checkedSites.push(thisSite)
            }
        
            // renderSpec(dataWithNulls, checkedSites)
          
        })
    })
}

// ---- gets checked sites, updates spec ---- // 
function getCheckedSites() {
    getChecked = document.querySelectorAll('input[type=checkbox]:checked');

    checkedSites = []; // clear the array of checked items
    for (let i = 0; i < getChecked.length; i++) {
        var siteName = getChecked[i].name
        var siteColor = getChecked[i].value
        var thisSite = {
            "siteName": `${siteName}`,
            "color": `${siteColor}`
        }
        checkedSites.push(thisSite)
    }

    // renderSpec(dataWithNulls, checkedSites)

}

// ---- PRINT RECENT AVERAGE TO TABLE ---- //

function printRecentAverage() {
    // first, creating convertData that has starttime in milliseconds 
    var convertData = []
    for (let i = 0; i < fullTable.length; i++) {
        convertData.push(fullTable[i])
        const date = new Date(convertData[i].starttime)
        let dateInMsec = Date.parse(date)
        convertData[i].starttime = dateInMsec
    }

    // console.log('convertData', convertData)

    // then, get the largest one
    var mostRecentTime = convertData[convertData.length - 1].starttime
    var startingTime = mostRecentTime - 86400000

    // then, filter everything over largest one minus 24 hours of milliseconds
    var last24HoursData = []
    for (let i = 0; i < convertData.length; i++) {
        if (convertData[i].starttime > startingTime) {
            last24HoursData.push(convertData[i])
        } else {}
    }

    // first, loop through and get values, and get max value
    for (let i = 0; i < activeMonitors.length; i++) {
        var thisLast = []
        thisLast = last24HoursData.filter(s => s.SiteName === activeMonitors[i].loc_col)

        // count if there are 17 entries
        if (thisLast.length > 17) {
            var average;
            var sum = []
            for (let i = 0; i < thisLast.length; i ++ ) {
                sum.push(thisLast[i].Value)
            }
    
            let totals = 0
            for (let i = 0; i < sum.length; i ++ ) {
                totals += sum[i]
            }
    
            average = totals / 24
            average = Math.round(average * 100) / 100

            values.push(average)
        }
    }

    // get max value
    max = Math.max(...values)
    var maxWidth = max * 1

    // get all names of active Monitors
    for (let i = 0; i < activeMonitors.length; i++) {
        // console.log(activeMonitors[i].loc_col)

        // for each of those names, filter last 24 hours of data
        var thisLast = []
        thisLast = last24HoursData.filter(s => s.SiteName === activeMonitors[i].loc_col)
        // console.log('this last:', thisLast)

        // count if there are 17 entries
        if (thisLast.length > 17) {
            var average;
            var sum = []
            for (let i = 0; i < thisLast.length; i ++ ) {
                sum.push(thisLast[i].Value)
            }
    
            let totals = 0
            for (let i = 0; i < sum.length; i ++ ) {
                totals += sum[i]
            }
    
            average = totals / 24
            average = Math.round(average * 100) / 100

            values.push(average)
    
            // console.log(activeMonitors[i].loc_col + ' average for this location over the last 24 hours: ' + average)
            var print = 'value-'+activeMonitors[i].loc_col+'-1'
            var print2 = 'value-'+activeMonitors[i].loc_col+'-2'
            document.getElementById(print).innerHTML = average 
            document.getElementById(print2).innerHTML = Math.round(average) // round to integer

                if (average > 35 ) {
                    document.getElementById('exceeds').classList.remove('hide')
                    document.getElementById('allUnder').classList.add('hide')
                    document.getElementById(print2).innerHTML += '<i class="fas fa-exclamation-circle ml-1" style="color:red">'
                }

            var cont = 'value-' + activeMonitors[i].loc_col + '-2';
            var widthPercent = 100 * Math.round(average)  / maxWidth
            document.getElementById(cont).style.width = widthPercent + "%"

        } else {
            // console.log(activeMonitors[i].loc_col + " doesn't have enough data")
            var print = 'value-'+activeMonitors[i].loc_col+'-1'
            var print2 = 'value-'+activeMonitors[i].loc_col+'-2'

            document.getElementById(print).innerHTML = 0
            document.getElementById(print2).innerHTML = '*'    
            
            var cont = 'value-' + activeMonitors[i].loc_col + '-2';
            document.getElementById(cont).style.backgroundColor = "white";
            document.getElementById('insufficient').classList.remove('hide')

        }
    }

    sortTable()
}


// --------------------------------------- CREATE LEAFLET MAP ---- // 
var map;
var monitors_group = L.featureGroup();
var monitors_group_noDEC = L.featureGroup();
var monitors;
var monitors_center = L.Point();
var monitors_bounds = L.Bounds();
var monitor_locations;

// draw map fires when data and monitor_locations load:
function drawMap() {

    monitor_locations = activeMonitors
    
    // adding each monitor to the feature group
    
    monitor_locations.forEach((monitor, i) => {
        
        let this_icon = L.colorIcon({
            iconSize : [30, 30],
            popupAnchor : [0, -15],
            iconUrl: "images/map-marker.svg",
            // color: color_convert.to_hex(monitor_locations[i].Color)
        });
        
        var this_monitor = 
            L.marker([monitor.Latitude, monitor.Longitude], {icon: this_icon, riseOnHover: true, riseOffset: 2000})
            .bindPopup(monitor.Location, {permanent: true, opacity: 0.85, interactive: true})
            .addTo(monitors_group)
        
        // create group without the DEC Monitor, which we'll use to set the center and bounds
        if (monitor.Location != "DEC Monitor Average") {
            var those_monitors = 
            L.marker([monitor.Latitude, monitor.Longitude], {icon: this_icon, riseOnHover: true, riseOffset: 2000})
            .bindTooltip(monitor.Location, {permanent: true, opacity: 0.85, interactive: true})
            .addTo(monitors_group_noDEC)
        }

        // setting tooltip mouseover rise-to-top

        var this_tooltip = this_monitor.getTooltip();
        

        // setting up zoom on click
        
        this_monitor.on('click', function (e) {
            map.setView(e.latlng, 13);
            updateData(monitor_locations[i].loc_col)
        });
        
    });

    monitors = monitors_group.getLayers();

    // getting the bounds of the markers
    
    monitors_bounds = monitors_group_noDEC.getBounds();
    
    // now getting the center of the bounds
    
    monitors_center = monitors_bounds.getCenter();
    
    // initiating the map object 
    
    map = L.map('map').setView(monitors_center, 10).fitBounds(monitors_bounds);

    // adding a tile layer
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // if Hamilton Bridge isn't reporting, add the marker anyway
    if (!stations.includes('Hamilton Bridge')) {drawHamiltonBridge()} 
    
    // adding the monitor markers to the map
    
    monitors_group.addTo(map);

    // ---- easyButton to clear the markers and lines ---- //
    
    L.easyButton({
        position: "bottomleft",
        states: [{
            title: "Zoom to fit",
            icon: "fas fa-undo",
            
            onClick: function() {
                
                resetZoom();
            }
        }]
    }).addTo(map);      
}

// ---- reset zoom on click ---- //

function resetZoom() {
    map.setView(monitors_center, 11).fitBounds(monitors_bounds);
    // loop through rows and remove .table-highlight
    var rows = document.querySelectorAll('.table-highlight')
    rows.forEach(row => row.classList.remove('table-highlight'))

    var sites = document.querySelectorAll('input[type=checkbox]:checked');
    sites.forEach(site => site.checked = false)

    checkedSites = [];
    renderSpec(dataWithNulls)
}

// ---- TIME FILTER ---- //

// event listener on the time-selection form
document.getElementById('inputNum').addEventListener('change', function (event) {
    event.preventDefault();
    inputNum = document.getElementById('inputNum').value;
    if (inputNum > 7) {
        console.log('too large');
        $("#sevenModal").modal()
    } else {
        updateTime(inputNum)
    }

});

// Time update function - uses transform[0].filter
function updateTime(x) {
    var last = fullTable.pop()
    const date = new Date(last.starttime)
    let dateInMsec = Date.parse(date)
    var filterTo = dateInMsec - x * 86400000

    chartStart = filterTo                   

    // renderSpec(dataWithNulls, checkedSites)

}


// ---- Update data based on map click ---- // 
function updateData(x) {
    // look in active monitors for x.
    var thisLocation = activeMonitors.filter(loc => loc.loc_col === x)

    var thisLoc = document.getElementById(thisLocation[0].loc_col)
    thisLoc.checked = true

    // loop through rows and remove .table-highlight
    var rows = document.querySelectorAll('.table-highlight')
    rows.forEach(row => row.classList.remove('table-highlight'))

    // add table row highlight...?
    var row = 'row-'+x
    document.getElementById(row).classList.add('table-highlight')

    // get all checked sites and update spec:
    getCheckedSites()

    // scroll chart into view (for mobile)
    document.getElementById('vis').scrollIntoView();

}

// -- DRAW HAMILTON BRIDGE ---- //
function drawHamiltonBridge() {
  console.log('Hamilton Bridge not reporting. Drawing point anyway')
  const hamiltonBridgeLocation = allMonitorLocations.filter(item => item.Location === 'Hamilton Bridge');

    let this_icon = L.colorIcon({
      iconSize : [30, 30],
      popupAnchor : [0, -15],
      iconUrl: "images/map-marker.svg",
      color: color_convert.to_hex(hamiltonBridgeLocation[0].Color)
    });

    var this_monitor = 
        L.marker([hamiltonBridgeLocation[0].Latitude, hamiltonBridgeLocation[0].Longitude], {icon: this_icon, riseOnHover: true, riseOffset: 2000})
        .bindPopup(`Hamilton Bridge`) // Add a popup with the location name
        .addTo(map)
}


// --- SORT TABLE FUNCTION ---- //
/*
Note: relies on an invisible column of just values. Values displayed as * are given a 0 in this column. 
*/
function sortTable() {
    // console.log('sort table running')
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById("table24");
    switching = true;
    // Make a loop that will continue until no switching has been done:*/
    while (switching) {
      //start by saying: no switching is done:
      switching = false;
      rows = table.rows;
      // Loop through all table rows (except the first, which contains table headers):*/
      for (i = 1; i < (rows.length - 1); i++) {
        //start by saying there should be no switching:
        shouldSwitch = false;
        // Get the two elements you want to compare, one from current row and one from the next:*/
        x = rows[i].getElementsByTagName("td")[0];
        y = rows[i + 1].getElementsByTagName("td")[0];
        // check if the two rows should switch place:
        if (Number(x.innerHTML) < Number(y.innerHTML)) {
          // if so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      }
      if (shouldSwitch) {
        // If a switch has been marked, make the switch and mark that a switch has been done:*/
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }

// Comparer Function - used later    
function GetSortOrder(prop) {    
    return function(a, b) {    
        if (a[prop] > b[prop]) {    
            return 1;    
        } else if (a[prop] < b[prop]) {    
            return -1;    
        }    
        return 0;    
    }    
}  


// ---- RENDER CHART SPEC ---- // 
async function renderSpec(
    data,
    checkedSites
) { 

    let chartSpec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "description": "PM2.5 in micrograms per cubic meter",
        "data": {
            "values": data,
            "format": {
                "parse": {
                    "Value": "number"
                }
            }
        },
        "config": {
          "legend": {"disable": true},
          "background": "#ffffff00",
          "axisX": {
            "grid": false, "ticks": true, "labels": true,
            "offset": 0,
            "domainDashOffset": 30,
            "labelAlign": "center",
            "labelExpr": "[timeFormat(datum.value, '%H') == 0 ? timeFormat(datum.value, '%b %e') : timeFormat(datum.value, '%-I %p')]",
            "labelPadding": 4,
            "labelOverlap": "parity",
            "tickSize": {
              "condition": {
                "test": {"field": "value", "timeUnit": "hours", "equal": 0},
                "value": 15
              },
              "value": 9
            },
            "tickWidth": {
              "condition": {
                "test": {"field": "value", "timeUnit": "hours", "equal": 0},
                "value": 1.25
              },
              "value": 0.5
            }
            },
          "axisY": {"domain": false, "ticks": false, "gridDash": [2], "gridWidth": 1,"offset": 10},
          "view": {"stroke": "transparent"}
        },
        "height": "container",
        "width": "container",
        "transform": [{"filter": `datum.starttime > ${chartStart}`}],
        "layer": [
            {
              "mark": {
                "type": "line",
                "tooltip": false
              },
              "encoding": {
                "x": {"field": "starttime", "type": "temporal", "title": ""},
                "y": {"field": "Value", "type": "quantitative", "title": " "},
                "color": {
                  "condition": {
                    "test": "datum.SiteName === locFilter",
                    "value": {"signal": "colorlabel"}
                  },
                  "field": "SiteName",
                  "type": "nominal",
                  "scale": {"range": ["lightgray"]}
                },
                
                "strokeWidth": {
                  "condition": {
                    "test": "datum.SiteName === locFilter",
                    "value": 2
                  },
                  "value": 0.5
                  }
              }
            },

          {
            "mark": "rule",
            "encoding": {
              "y": {"datum": 35},
              "color": {"value": "red"},
              "size": {"value": 2},
              "strokeDash": {"value": [2, 2]}
            }
          }
        ]
      }

      // vega-Lite spec
      console.log('vega-lite spec:')
      console.log(chartSpec)

      // compile chartSpec to vega
      const vegaSpec = vegaLite.compile(chartSpec).spec;

      const colorSignal = {
          "name": "colorlabel",
          "value": "black",
          "on": [
            {
              "events": ".colorLabel:click",
              "update": "event.currentTarget.innerText",
              "force":  true
            }
          ]
        }

      const textSignal = {
          "name": "textlabel",
          "value": "BQE",
          "on": [
            {
              "events": ".lineLabel:click",
              "update": "event.currentTarget.innerText",
              "force":  true
            }
          ]
        }

        const locSignal =  {
          "name": "locFilter", 
          "value": "FDR",
          "on": [
            {
              "events": ".lineLabel:click",
              "update": "event.currentTarget.innerText",
              "force": true
            }
          ]
        }
 

      const textMark =  {
          "type": "text",
          "encode": {
            "enter": {
              "x": {"value": 0},
              "y": {"value": 20}
            },
            "update": {
              "text": {"signal": "textlabel"}
            }
          }
        }

      vegaSpec.signals.push(colorSignal)
      
      vegaSpec.signals.push(textSignal)
      
      vegaSpec.signals.push(locSignal)

      vegaSpec.marks.push(textMark)
      
      console.log('vega spec:')
      console.log(vegaSpec)


      vegaEmbed('#vis',vegaSpec).then(res => {
        myView = res.view // save the vega view 
        console.log('myView, vega with marks pushed:')
        console.log(myView)
      })
}


</script>


</body>
</html>